
services:
  web-app:
    build:
      context: .
      dockerfile: Dockerfile-Prod
    ports:
      - 4443:443
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - db
      - cache
    volumes:
      - /var/www/html/SileriumPHP/.env:/var/www/.env
    links:
      - db
    networks:
      - backend
      - cache
  phpmyadmin:
    image: phpmyadmin
    restart: unless-stopped
    ports:
      - 8081:80
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend
    depends_on:
      - db
  mailpit:
    image: axllent/mailpit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    ports:
      - 8825:8025
      - 1125:1025
    networks:
      - backend
    depends_on:
      - web-app
  db:
    image: mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      - MYSQL_ROOT_PASSWORD=SAmsuNG123sileriumdb
      - MYSQL_DATABASE=sileriumdb
      - MYSQL_USER=app
      - MYSQL_PASSWORD=SAmsuNG123sileriumdb
      - LANG=C.UTF_8
    command: 
    - --character-set-server=utf8mb4 
    - --collation-server=utf8mb4_unicode_ci
    volumes:
      - backend-data:/var/lib/mysql/
    networks:
      - backend
  cache:
    image: memcached:1.6.24
    restart: unless-stopped
    command:
      - --conn-limit=1024
      - --threads=4
      - --memory-limit=4096
    networks:
      - cache
networks:
  backend:
  cache:
volumes:
  backend-data: