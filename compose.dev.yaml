services:
  web-app:
    build:
      context: .
      dockerfile: docker/development/Dockerfile
    ports:
      - 8888:80
    healthcheck:
      test: ["CMD", "curl", "-kf", "http://127.0.0.1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_started
    user: "vodev:www-data"
    volumes:
      - ./app:/var/www/app
      - ./routes:/var/www/routes
      - ./storage:/var/www/storage
      - ./database:/var/www/database
      - ./.env.development:/var/www/.env
      - ./public:/var/www/public
      - ./docker/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
      - ./docker/silerium-dev.conf:/etc/apache2/sites-enabled/silerium-dev.conf:ro
      - ./docker/mysql_custom.cnf:/etc/mysql/conf.d/mysql_custom.cnf:ro
    develop:
      watch:
        - action: sync+exec
          path: ./resources
          target: /var/www/resources
          exec:
            command: npm run build
          initial_sync: true
    networks:
      - backend-dev
      - cache-dev
  dbgate:
    image: dbgate/dbgate
    restart: unless-stopped
    ports:
      - 8033:3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      CONNECTIONS: mysql

      LABEL_mysql: MySql
      SERVER_mysql: db
      DATABASE_mysql: sileriumdb_development
      USER_mysql: root
      PASSWORD_mysql: SAmsuNG123sileriumdb
      PORT_mysql: 3306
      ENGINE_mysql: mysql@dbgate-plugin-mysql

      LOGIN: root
      PASSWORD: SAmsuNG123sileriumdb
      LOGIN_PERMISSIONS_app: "*"

    volumes:
      - dbgate-dev-data:/root/.dbgate
    networks:
      - backend-dev
    depends_on:
      db:
        condition: service_healthy
  mailpit:
    image: axllent/mailpit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    ports:
      - 8855:8025
      - 1155:1025
    networks:
      - backend-dev
    depends_on:
      web-app:
        condition: service_healthy
  db:
    image: mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      - MYSQL_PASSWORD=SAmsuNG123sileriumdb
      - MYSQL_USER=app
      - MYSQL_DATABASE=sileriumdb_development
      - LANG=C.UTF_8
    command: 
    - --character-set-server=utf8mb4 
    - --collation-server=utf8mb4_unicode_ci
    volumes:
      - backend-dev-data:/var/lib/mysql/
    networks:
      - backend-dev
  cache:
    image: memcached:1.6.24
    restart: unless-stopped
    command:
      - --conn-limit=1024
      - --threads=4
      - --memory-limit=4096
    networks:
      - cache-dev
networks:
  backend-dev:
  cache-dev:
volumes:
  backend-dev-data:
  dbgate-dev-data:
    driver: local